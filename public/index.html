<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STELLA - IA Autonome</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚≠ê</text></svg>">
    <style>
        :root{--gold:#de9f49;--black:#121212;--white:#fff;--beige:#fdf8f3;--gray:#6b7280;--green:#10b981;--red:#ef4444}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--beige);color:var(--black);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--black),#2d2d2d);color:var(--white);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .logo{display:flex;align-items:center;gap:.75rem}
        .logo-icon{font-size:1.75rem}
        .logo-text{font-size:1.5rem;font-weight:700;color:var(--gold)}
        .logo-sub{font-size:.7rem;color:var(--gray)}
        .status{display:flex;align-items:center;gap:.5rem;background:rgba(16,185,129,.2);padding:.5rem 1rem;border-radius:2rem;font-size:.8rem}
        .dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .caps{background:var(--black);padding:.5rem 1rem;display:flex;gap:.5rem;overflow-x:auto;font-size:.7rem}
        .cap{background:rgba(222,159,73,.2);color:var(--gold);padding:.2rem .6rem;border-radius:1rem;white-space:nowrap}
        .container{max-width:900px;margin:0 auto;padding:1rem}
        .card{background:var(--white);border-radius:1rem;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:1rem;overflow:hidden}
        .card-head{background:var(--black);color:var(--white);padding:.75rem 1rem;display:flex;justify-content:space-between;align-items:center;font-size:.9rem;font-weight:600}
        .kpis{display:flex;gap:.5rem;padding:.75rem;flex-wrap:wrap}
        .kpi{background:var(--beige);padding:.5rem .75rem;border-radius:.5rem;text-align:center;flex:1;min-width:70px}
        .kpi-label{font-size:.6rem;color:var(--gray);text-transform:uppercase}
        .kpi-val{font-size:1.1rem;font-weight:700}
        .kpi-val.bad{color:var(--red)}
        .kpi-val.good{color:var(--green)}
        .chat-box{display:flex;flex-direction:column;height:calc(100vh - 220px);min-height:350px}
        .messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.6rem}
        .msg{max-width:88%;padding:.6rem .9rem;border-radius:.9rem;font-size:.88rem;line-height:1.45}
        .msg.user{background:var(--gold);color:var(--white);align-self:flex-end;border-bottom-right-radius:.2rem}
        .msg.bot{background:var(--beige);align-self:flex-start;border-bottom-left-radius:.2rem}
        .msg.sys{background:#dbeafe;color:#1e40af;align-self:center;font-size:.75rem;padding:.4rem .8rem}
        .msg h2,.msg h3{font-size:.95rem;margin:.4rem 0;color:var(--gold)}
        .msg ul{margin-left:1.1rem}
        .msg code{background:#e5e7eb;padding:.1rem .3rem;border-radius:.2rem;font-size:.8em}
        .msg pre{background:#1f2937;color:#f3f4f6;padding:.6rem;border-radius:.4rem;overflow-x:auto;font-size:.75em;margin:.4rem 0}
        .typing{display:flex;gap:4px;padding:.6rem .9rem;background:var(--beige);border-radius:.9rem;align-self:flex-start}
        .typing span{width:7px;height:7px;background:var(--gray);border-radius:50%;animation:bounce 1.4s infinite}
        .typing span:nth-child(2){animation-delay:.2s}
        .typing span:nth-child(3){animation-delay:.4s}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
        .input-area{padding:.75rem;border-top:1px solid #eee}
        .quick{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.6rem}
        .qbtn{background:var(--white);border:1px solid var(--gold);color:var(--gold);padding:.3rem .6rem;border-radius:2rem;font-size:.7rem;cursor:pointer;transition:.2s}
        .qbtn:hover{background:var(--gold);color:var(--white)}
        .input-row{display:flex;gap:.4rem}
        .input{flex:1;padding:.75rem;border:2px solid #e5e7eb;border-radius:.6rem;font-size:1rem;outline:none}
        .input:focus{border-color:var(--gold)}
        .send{background:var(--gold);color:var(--white);border:none;padding:.75rem 1rem;border-radius:.6rem;font-size:1rem;font-weight:600;cursor:pointer}
        .send:disabled{background:#ccc}
        .upload-btn{background:var(--beige);border:1px solid var(--gold);color:var(--gold);padding:.75rem;border-radius:.6rem;cursor:pointer;font-size:1rem}
        .refresh{background:0;border:1px solid var(--gold);color:var(--gold);padding:.2rem .4rem;border-radius:.3rem;font-size:.65rem;cursor:pointer}
        .session-info{font-size:.65rem;color:var(--gray);padding:.25rem .75rem;text-align:right}
        @media(max-width:640px){.header{padding:.6rem .8rem}.logo-text{font-size:1.2rem}.chat-box{height:calc(100vh - 200px)}}
    </style>
</head>
<body>
    <header class="header">
        <div class="logo"><span class="logo-icon">‚≠ê</span><div><div class="logo-text">STELLA</div><div class="logo-sub">IA Autonome v2.1</div></div></div>
        <div class="status"><span class="dot"></span><span>En ligne</span></div>
    </header>
    <div class="caps">
        <span class="cap">üìä Shopify</span>
        <span class="cap">üóÑÔ∏è Supabase</span>
        <span class="cap">üíª GitHub</span>
        <span class="cap">üöÄ Deploy</span>
        <span class="cap">üß† M√©moire</span>
        <span class="cap">üìé Fichiers</span>
    </div>
    <main class="container">
        <div class="card">
            <div class="card-head"><span>üìä KPIs</span><button class="refresh" onclick="loadKPIs()">üîÑ</button></div>
            <div class="kpis">
                <div class="kpi"><div class="kpi-label">CA Jour</div><div class="kpi-val" id="ca">--</div></div>
                <div class="kpi"><div class="kpi-label">Commandes</div><div class="kpi-val" id="cmd">--</div></div>
                <div class="kpi"><div class="kpi-label">Panier</div><div class="kpi-val" id="pan">--</div></div>
                <div class="kpi"><div class="kpi-label">Objectif</div><div class="kpi-val" id="prog">--%</div></div>
            </div>
        </div>
        <div class="card">
            <div class="card-head"><span>üí¨ Chat</span><button class="refresh" onclick="newSession()">üÜï Nouveau</button></div>
            <div class="session-info">Session: <span id="sid">-</span></div>
            <div class="chat-box">
                <div class="messages" id="msgs"></div>
                <div class="input-area">
                    <div class="quick">
                        <button class="qbtn" onclick="ask('Briefing du jour')">üìã Briefing</button>
                        <button class="qbtn" onclick="ask('Liste les fichiers GitHub')">üìÅ GitHub</button>
                        <button class="qbtn" onclick="ask('Quelles tables dans Supabase ?')">üóÑÔ∏è Tables</button>
                        <button class="qbtn" onclick="ask('Modifie ton code pour ajouter une fonctionnalit√© de test')">üîß Auto-modifier</button>
                    </div>
                    <div class="input-row">
                        <label class="upload-btn" title="Envoyer un fichier">üìé<input type="file" id="file" style="display:none" onchange="uploadFile()"></label>
                        <input type="text" class="input" id="inp" placeholder="Message..." onkeypress="if(event.key==='Enter')send()">
                        <button class="send" id="btn" onclick="send()">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        const API='';
        let sid=localStorage.getItem('stella_sid')||'s-'+Date.now();
        localStorage.setItem('stella_sid',sid);
        document.getElementById('sid').textContent=sid.substring(0,12)+'...';

        function md(t){if(!t)return'';return t.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/^### (.*$)/gm,'<h3>$1</h3>').replace(/^## (.*$)/gm,'<h2>$1</h2>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/^- (.*$)/gm,'<li>$1</li>').replace(/(<li>.*<\/li>\n?)+/g,'<ul>$&</ul>').replace(/\n/g,'<br>');}

        async function loadKPIs(){
            try{const r=await fetch(API+'/kpis');const d=await r.json();
            const ca=parseFloat(d.ca_jour)||0;
            document.getElementById('ca').textContent=ca.toLocaleString('fr-FR')+'‚Ç¨';
            document.getElementById('ca').className='kpi-val '+(ca<1000?'bad':ca>=2000?'good':'');
            document.getElementById('cmd').textContent=d.nb_commandes||0;
            document.getElementById('pan').textContent=(d.panier_moyen||0)+'‚Ç¨';
            document.getElementById('prog').textContent=d.progression||'0%';}catch(e){}}

        async function loadHistory(){
            try{const r=await fetch(API+'/conversations/'+sid);const d=await r.json();
            const box=document.getElementById('msgs');
            box.innerHTML='<div class="msg sys">‚≠ê STELLA v2.1 - Conversations persistantes. Session: '+sid.substring(0,8)+'</div>';
            if(d.messages&&d.messages.length>0){
                for(const m of d.messages){
                    if(m.role==='user'&&typeof m.content==='string'){
                        box.innerHTML+=`<div class="msg user">${esc(m.content)}</div>`;
                    }else if(m.role==='assistant'){
                        const txt=Array.isArray(m.content)?m.content.find(b=>b.type==='text')?.text:m.content;
                        if(txt)box.innerHTML+=`<div class="msg bot">${md(txt)}</div>`;
                    }
                }
                box.scrollTop=box.scrollHeight;
            }}catch(e){document.getElementById('msgs').innerHTML='<div class="msg sys">‚≠ê STELLA v2.1 Autonome. Nouvelle session.</div>';}}

        async function send(){
            const i=document.getElementById('inp');const m=i.value.trim();if(!m)return;
            const box=document.getElementById('msgs');const btn=document.getElementById('btn');
            box.innerHTML+=`<div class="msg user">${esc(m)}</div>`;i.value='';btn.disabled=true;
            box.innerHTML+=`<div class="typing" id="t"><span></span><span></span><span></span></div>`;
            box.scrollTop=box.scrollHeight;
            try{const r=await fetch(API+'/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m,session_id:sid})});
            const d=await r.json();document.getElementById('t')?.remove();
            box.innerHTML+=`<div class="msg bot">${d.success?md(d.message):'‚ùå '+d.error}</div>`;}
            catch(e){document.getElementById('t')?.remove();box.innerHTML+=`<div class="msg bot">‚ùå Erreur connexion</div>`;}
            btn.disabled=false;box.scrollTop=box.scrollHeight;loadKPIs();}

        async function uploadFile(){
            const f=document.getElementById('file').files[0];if(!f)return;
            const box=document.getElementById('msgs');const btn=document.getElementById('btn');
            box.innerHTML+=`<div class="msg user">üìé ${f.name}</div>`;btn.disabled=true;
            box.innerHTML+=`<div class="typing" id="t"><span></span><span></span><span></span></div>`;
            box.scrollTop=box.scrollHeight;
            const reader=new FileReader();
            reader.onload=async function(e){
                const content=e.target.result;
                try{const r=await fetch(API+'/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename:f.name,content:content,session_id:sid})});
                const d=await r.json();document.getElementById('t')?.remove();
                box.innerHTML+=`<div class="msg bot">${d.success?md(d.message):'‚ùå '+d.error}</div>`;}
                catch(e){document.getElementById('t')?.remove();box.innerHTML+=`<div class="msg bot">‚ùå Erreur upload</div>`;}
                btn.disabled=false;box.scrollTop=box.scrollHeight;};
            reader.readAsText(f);}

        function ask(q){document.getElementById('inp').value=q;send();}
        function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
        function newSession(){sid='s-'+Date.now();localStorage.setItem('stella_sid',sid);document.getElementById('sid').textContent=sid.substring(0,12)+'...';document.getElementById('msgs').innerHTML='<div class="msg sys">‚≠ê Nouvelle session cr√©√©e</div>';}

        loadKPIs();loadHistory();setInterval(loadKPIs,5*60*1000);
    </script>
</body>
</html>
